<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Rich Text Editor</title>
    <style>
         body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80%;
        }

        .title-box, .editor-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .title-input, .editor {
            width: 40%;  /* Adjusted width to make the boxes narrower */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .side-controls {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centering the controls vertically */
        }

        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .button2 {
            padding: 20px 40px;
            font-size: 24px;
            cursor: pointer;
            margin: 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            color: white;
            text-decoration: none;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .button2:hover {
            background: linear-gradient(45deg, #45a049, #1976D2);
        }
    </style>
</head>
<body>

    <div class="container">

        <h3>Title:</h3>
        <div class="title-box">
            <div class="title-input" contenteditable="true" id="titleInput" placeholder="Enter title here"></div><label for="titleInput">‎‎‎‎⠀⠀ ⠀</label>
        </div>

        <div class="editor-container">
            <div class="side-controls">
                <input type="checkbox" id="boldCheckbox" onchange="toggleFormatting('bold')"> Bold
                <input type="checkbox" id="italicCheckbox" onchange="toggleFormatting('italic')"> Italic
                <input type="checkbox" id="underlineCheckbox" onchange="toggleFormatting('underline')"> Underline
            </div>

            <div class="editor" contenteditable="true" id="editor">
                Start typing here...
            </div>

            <div class="side-controls">
                <input type="number" id="fontSizeInput" min="50" max="200" step="10" value="100"> Font Size (%)
                <button onclick="applyFontSize()">Apply Size</button><br>
                <input type="color" id="colorInput" value="#000000"> Text Color
                <button onclick="applyColor()">Apply Color</button>
            </div>
        </div>
        <p>
            <button onclick="clearAllSizes()">Clear All Sizes</button> <button onclick="copyFormattedHtml()">Copy As Html Formatted</button>
            <button onclick="clearAllColors()">Clear All Colors</button> <br><br>
        </p>

        <p>Keybinds: <b>ctrl + b</b> | <b>ctrl + i</b> | <b>ctrl + u</b><br><br></p>

        <p>
            READ BEFORE USING: This is a standalone editor to copy text formatted as HTML, you will have to add the tag yourself (example "rules:"). <br>
            Familiarize yourself with the <a href="guide.html">Welcome Msg GUIDE</a> before usage. <br>
            I recommend to put size & colors last. Or at least don't edit ones you already edited (kinda wack rn if u do).<br>
            Title won't work if you don't have TOHE 2.0.0 access. <br>
            I will try to update it to make it more automatic, but as of currently be aware of these stuff. Also will make it look much more prettier than it is rn in the near future.<br>
        </p>

        <button class="button2" onclick="location.href='index.html'">Go Back</button>
    </div>

    <script>
        function rgbToHex(rgb) {
            let [r, g, b] = rgb.match(/\d+/g).map(Number);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function toggleFormatting(format) {
            var activeElement = document.activeElement; // Get the currently focused element
            document.execCommand(format);
            updateCheckboxStatesBasedOnSelection(activeElement);
        }

        function applyFontSize() {
            var size = document.getElementById('fontSizeInput').value + '%';
            applyStyle('fontSize', size);
        }

        function applyColor() {
            var color = document.getElementById('colorInput').value;
            applyStyle('color', color);
        }

        function applyStyle(styleType, value) {
            var selection = window.getSelection();
            if (!selection.isCollapsed) {
                var range = selection.getRangeAt(0);
                var span = document.createElement('span');
                span.style[styleType] = value;
                span.appendChild(range.extractContents());
                range.insertNode(span);

                var space = document.createTextNode("\u200B"); // Using Unicode Character '⠀'
                span.parentNode.insertBefore(space, span.nextSibling);
                range.setStartAfter(space);
                range.setEndAfter(space);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function clearExistingStyles(node, styleType) {
            if (node.querySelectorAll) {
                var spans = node.querySelectorAll('span');
                spans.forEach(span => {
                    span.style[styleType] = '';
                    if (!span.style.cssText) {
                        var parent = span.parentNode;
                        while (span.firstChild) parent.insertBefore(span.firstChild, span);
                        parent.removeChild(span);
                    }
                });
            }
        }
        function updateCheckboxStates() {
            // This function is called with no specific target, updates based on any active element
            updateCheckboxStatesBasedOnSelection(document.activeElement);
        }

        function updateCheckboxStatesBasedOnSelection(activeElement) {
            var isBold = document.queryCommandState('bold');
            var isItalic = document.queryCommandState('italic');
            var isUnderline = document.queryCommandState('underline');

            document.getElementById('boldCheckbox').checked = isBold;
            document.getElementById('italicCheckbox').checked = isItalic;
            document.getElementById('underlineCheckbox').checked = isUnderline;
        }

        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey && (event.key === 'b' || event.key === 'i' || event.key === 'u')) {
                event.preventDefault(); // Prevent default to stop any browser-specific functionality
                var cmd = (event.key === 'b') ? 'bold' : (event.key === 'i' ? 'italic' : 'underline');
                toggleFormatting(cmd);
            }
        });

        // Clear styles functions
        function clearAllStyles(styleType) {
            ['titleInput', 'editor'].forEach(id => {
                var node = document.getElementById(id);
                var spans = node.querySelectorAll('span');
                spans.forEach(span => {
                    span.style[styleType] = '';
                    if (!span.style.cssText) {
                        var parent = span.parentNode;
                        while (span.firstChild) parent.insertBefore(span.firstChild, span);
                        parent.removeChild(span);
                    }
                });
            });
            document.getElementById('editor').normalize(); // Normalize the editor
        }


        function clearAllSizes() {
            clearAllStyles('fontSize');
        }

        function clearAllColors() {
            clearAllStyles('color');
        }

        function copyFormattedHtml() {
            var title = document.getElementById('titleInput').innerHTML.trim();
            var editorContent = document.getElementById('editor').innerHTML;

            // Function to convert RGB to Hex
            function convertToHex(color) {
                return color.trim().startsWith('rgb') ? rgbToHex(color) : color;
            }

            // Apply formatting transformations to the title
            if (title) {
                title = title.replace(/<span style="font-size:([^;]+); color:([^;]+);?">/g, (match, size, color) => {
                    return `<size=${size.trim()}><color=${convertToHex(color)}>`;
                }).replace(/<span style="font-size:([^;]+);?">/g, (match, size) => {
                    return `<size=${size.trim()}>`;
                }).replace(/<span style="color:([^;]+);?">/g, (match, color) => {
                    return `<color=${convertToHex(color)}>`;
                }).replace(/<\/span>/g, '</color></size>');
            }

            // Apply formatting transformations to the editor content
            editorContent = editorContent.replace(/<div>/g, '<br>').replace(/<\/div>/g, '').replace(/\n/g, '<br>');
            editorContent = editorContent.replace(/<span style="font-size:([^;]+); color:([^;]+);?">/g, (match, size, color) => {
                return `<size=${size.trim()}><color=${convertToHex(color)}>`;
            }).replace(/<span style="font-size:([^;]+);?">/g, (match, size) => {
                return `<size=${size.trim()}>`;
            }).replace(/<span style="color:([^;]+);?">/g, (match, color) => {
                return `<color=${convertToHex(color)}>`;
            }).replace(/<\/span>/g, '</color></size>');

            // Remove the first <br> from editor content if it exists at the start
            editorContent = editorContent.replace(/^(<br>)/, '');

            // Concatenate title and content, ensuring line breaks are removed
            var fullContent = title ? '<title>' + title + '</title>' : '';
            fullContent += editorContent;
            fullContent = fullContent.replace(/\u2800/g, '').replace(/[\r\n\t]+/g, ''); // Remove all line breaks and tabs

            // Copy to clipboard
            navigator.clipboard.writeText(fullContent)
                .then(() => alert('Formatted HTML copied to clipboard'))
                .catch(err => console.error('Failed to copy: ', err));
        }

        function updateCheckboxStates() {
            document.getElementById('boldCheckbox').checked = document.queryCommandState('bold');
            document.getElementById('italicCheckbox').checked = document.queryCommandState('italic');
            document.getElementById('underlineCheckbox').checked = document.queryCommandState('underline');
        }
    </script>

</body>
</html>
